import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Sole } from 'src/entities/sole.entity';
import { Exploitation } from 'src/entities/exploitation.entity';
import { Repository } from 'typeorm';
import { CreateSoleDTO } from './dtos/create.sole.dto';
import { UpdateSoleDTO } from './dtos/update.sole.dto';

@Injectable()
export class SoleService {
  constructor(
    @InjectRepository(Sole)
    private readonly soleRepository: Repository<Sole>,

    @InjectRepository(Exploitation)
    private readonly exploitationRepository: Repository<Exploitation>,
  ) {}

  async getAllSoles() {
    return this.soleRepository.find({ relations: ['exploitation', 'boards'] });
  }

  async getSoleById(id: number) {
    return this.soleRepository.findOne({
      where: { id_sole: id },
      relations: [
        'exploitation',
        'boards',
        'boards.sectionPlans',
        'boards.sectionPlans.sections',
        'boards.sectionPlans.sections.vegetable', 
        'boards.sectionPlans.sections.waterings',
      ],
    });
  }

  async createSole(payload: CreateSoleDTO) {
    const exploitation = await this.exploitationRepository.findOne({
      where: { id_exploitation: payload.id_exploitation },
    });
    if (!exploitation) throw new NotFoundException('Exploitation not found');

    const sole = this.soleRepository.create({
      sole_name: payload.sole_name,
      exploitation,
    });

    return this.soleRepository.save(sole);
  }

  async updateSole(payload: UpdateSoleDTO) {
    const sole = await this.soleRepository.findOne({
      where: { id_sole: payload.id_sole },
    });
    if (!sole) throw new NotFoundException('Sole not found');

    if (payload.id_exploitation) {
      const exploitation = await this.exploitationRepository.findOne({
        where: { id_exploitation: payload.id_exploitation },
      });
      if (!exploitation) throw new NotFoundException('Exploitation not found');
      sole.exploitation = exploitation;
    }

    Object.assign(sole, payload);
    return this.soleRepository.save(sole);
  }

  async delSole(id: number) {
    const sole = await this.soleRepository.findOne({ where: { id_sole: id } });
    if (!sole) throw new NotFoundException('Sole not found');

    await this.soleRepository.delete({ id_sole: id });
    return { msg: 'Sole deleted successfully' };
  }
}
