import { SearchExploitationQueryDto } from './dtos/exploitation.search.query.dto';
import { Body, Controller, Get, Param, ParseIntPipe, Post, Put, Query, UseGuards } from '@nestjs/common';
import { CreateExploitationDTO } from './dtos/create.exploitation.dto';
import { UpdateExploitationDTO } from './dtos/update.exploitation.dto';
import { Exploitation } from 'src/entities/exploitation.entity';
import { ExploitationService } from './exploitation.service';
import { ApiOperation, ApiResponse, ApiTags, ApiSecurity, ApiParam, ApiBody, ApiQuery } from '@nestjs/swagger';
import { AuthChard } from 'src/users/guards/auth.guard';
import { PermissionsGuard } from 'src/users/guards/permissions.guard';
import { Permission } from 'src/users/permissions/permission.enum';
import { RequiertPermissions } from 'src/users/decorators/permissions.decorator';


@ApiTags('Exploitations')
@Controller('exploitation')
export class ExploitationController {
  constructor(private readonly exploitationService: ExploitationService) {}

  /**
   * Récupérer toutes les exploitations - FORMATEUR peut voir toutes, STAGIAIRE voit les siennes
   */
  @Get()
  @UseGuards(AuthChard)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Récupère toutes les exploitations' })
  @ApiResponse({ status: 200, description: 'Exploitations récupérées avec succès', type: [Exploitation] })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  async getAllExploitations() {
    return this.exploitationService.getAllExploitations();
  }

  /**
   * Récupérer une exploitation par ID - Accessible aux utilisateurs authentifiés
   */
  @Get(':id')
  @UseGuards(AuthChard)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Récupère une exploitation par ID' })
  @ApiParam({ name: 'id', type: Number, description: 'ID de l\'exploitation' })
  @ApiResponse({ status: 200, description: 'Exploitation récupérée avec succès', type: Exploitation })
  @ApiResponse({ status: 404, description: 'Exploitation non trouvée' })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  async getExploitation(@Param('id', ParseIntPipe) id: number) {
    return this.exploitationService.getExploitationById(id);
  }

  /**
   * Rechercher des exploitations par nom - Accessible aux utilisateurs authentifiés
   */
  @Get('search/name')
  @UseGuards(AuthChard)
  @ApiSecurity('bearer')
  @ApiOperation({
    summary: 'Recherche des exploitations par nom exact ou par proximité (SQL LIKE)',
    description: "Retourne les exploitations dont le nom correspond exactement ou contient le terme de recherche (ex: 'Ciney' trouve 'Ferme de Ciney').",
  })
  @ApiQuery({ name: 'searchName', type: String, description: 'Nom ou partie du nom de l\'exploitation' })
  @ApiResponse({ status: 200, description: 'Liste des exploitations trouvées', type: [Exploitation] })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  async searchExploitations(
    @Query() query: SearchExploitationQueryDto,
  ): Promise<Exploitation[]> {
    return this.exploitationService.getByLikeOrExactName(query.searchName);
  }

  /**
   * Créer une exploitation - FORMATEUR uniquement
   */
  @Post()
  @UseGuards(AuthChard, PermissionsGuard)
  @RequiertPermissions(Permission.CREER_EXPLOITATION)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Crée une nouvelle exploitation' })
  @ApiBody({ type: CreateExploitationDTO })
  @ApiResponse({ status: 201, description: 'Exploitation créée avec succès', type: Exploitation })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  @ApiResponse({ status: 403, description: 'Permission refusée - Réservé aux formateurs' })
  async createExploitation(@Body() payload: CreateExploitationDTO) {
    return this.exploitationService.createExploitation(payload);
  }

  /**
   * Mettre à jour une exploitation - FORMATEUR uniquement
   */
  @Put()
  @UseGuards(AuthChard, PermissionsGuard)
  @RequiertPermissions(Permission.MODIFIER_SUPPRIMER_EXPLOITATION)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Met à jour une exploitation' })
  @ApiBody({ type: UpdateExploitationDTO })
  @ApiResponse({ status: 200, description: 'Exploitation mise à jour avec succès', type: Exploitation })
  @ApiResponse({ status: 404, description: 'Exploitation non trouvée' })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  @ApiResponse({ status: 403, description: 'Permission refusée - Réservé aux formateurs' })
  async updateExploitation(@Body() payload: UpdateExploitationDTO) {
    return this.exploitationService.updateExploitation(payload);
  }

  // @Delete(':id')
  // @UseGuards(AuthChard, PermissionsGuard)
  // @RequiertPermissions(Permission.MODIFIER_SUPPRIMER_EXPLOITATION)
  // @ApiSecurity('bearer')
  // @ApiOperation({ summary: 'Supprime une exploitation' })
  // @ApiParam({ name: 'id', type: Number, description: 'ID de l\'exploitation à supprimer' })
  // @ApiResponse({ status: 200, description: 'Exploitation supprimée avec succès' })
  // @ApiResponse({ status: 404, description: 'Exploitation non trouvée' })
  // @ApiResponse({ status: 401, description: 'Non authentifié' })
  // @ApiResponse({ status: 403, description: 'Permission refusée - Réservé aux formateurs' })
  // async delExploitation(@Param('id', ParseIntPipe) id: number) {
  //   return this.exploitationService.delExploitation(id);
  // }
}