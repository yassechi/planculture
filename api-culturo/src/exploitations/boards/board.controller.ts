import { ApiOperation, ApiSecurity, ApiResponse, ApiTags, ApiParam, ApiBody } from '@nestjs/swagger';
import { BoardService } from './board.service';

import {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  ParseIntPipe,
  Post,
  Put,
  UseGuards,
} from '@nestjs/common';
import { CreateBoardDTO } from './dtos/create.board.dto';
import { UpdateBoardDTO } from './dtos/update.board.dto';
import { AuthChard } from 'src/users/guards/auth.guard';
import { PermissionsGuard } from 'src/users/guards/permissions.guard';
import { Permission } from 'src/users/permissions/permission.enum';
import { RequiertPermissions } from 'src/users/decorators/permissions.decorator';
import { Board } from 'src/entities/board.entity';

@ApiTags('Boards')
@Controller('boards')
export class BoardController {
  constructor(private readonly boardService: BoardService) {}

  /**
   * Récupérer toutes les planches - Accessible aux utilisateurs authentifiés
   */
  @Get()
  @UseGuards(AuthChard)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Récupère toutes les planches' })
  @ApiResponse({ status: 200, description: 'Liste de toutes les planches', type: [Board] })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  public async getAllBoards() {
    return this.boardService.getAllBoards();
  }

  /**
   * Récupérer une planche par ID - Accessible aux utilisateurs authentifiés
   */
  @Get('/:id')
  @UseGuards(AuthChard)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Récupère une planche par ID' })
  @ApiParam({ name: 'id', type: Number, description: 'ID de la planche' })
  @ApiResponse({ status: 200, description: 'Planche trouvée', type: Board })
  @ApiResponse({ status: 404, description: 'Planche non trouvée' })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  async getOnePlanche(@Param('id', ParseIntPipe) id: number) {
    return await this.boardService.getBoardById(id);
  }

  /**
   * Créer une planche - Uniquement FORMATEUR
   */
  @Post()
  @UseGuards(AuthChard, PermissionsGuard)
  @RequiertPermissions(Permission.CREER_EXPLOITATION)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Crée une nouvelle planche' })
  @ApiBody({ type: CreateBoardDTO })
  @ApiResponse({ status: 201, description: 'Planche créée', type: Board })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  @ApiResponse({ status: 403, description: 'Permission refusée - Réservé aux formateurs' })
  async createBoard(@Body() board: CreateBoardDTO) {
    return this.boardService.createBoard(board);
  }

  /**
   * Mettre à jour une planche - Uniquement FORMATEUR
   */
  @Put()
  @UseGuards(AuthChard, PermissionsGuard)
  @RequiertPermissions(Permission.MODIFIER_SUPPRIMER_EXPLOITATION)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Met à jour une planche' })
  @ApiBody({ type: UpdateBoardDTO })
  @ApiResponse({ status: 200, description: 'Planche mise à jour', type: Board })
  @ApiResponse({ status: 404, description: 'Planche non trouvée' })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  @ApiResponse({ status: 403, description: 'Permission refusée - Réservé aux formateurs' })
  async updateBoard(@Body() board: UpdateBoardDTO) {
    return this.boardService.updateBoard(board); 
  }

  /**
   * Supprimer une planche - Uniquement FORMATEUR
   */
  @Delete('/:id')
  @UseGuards(AuthChard, PermissionsGuard)
  @RequiertPermissions(Permission.MODIFIER_SUPPRIMER_EXPLOITATION)
  @ApiSecurity('bearer')
  @ApiOperation({ summary: 'Supprime une planche' })
  @ApiParam({ name: 'id', type: Number, description: 'ID de la planche à supprimer' })
  @ApiResponse({ status: 204, description: 'Planche supprimée' })
  @ApiResponse({ status: 404, description: 'Planche non trouvée' })
  @ApiResponse({ status: 401, description: 'Non authentifié' })
  @ApiResponse({ status: 403, description: 'Permission refusée - Réservé aux formateurs' })
  async deleteBoard(@Param('id', ParseIntPipe) id: number) {
    return this.boardService.delBoard(id);
  }
}